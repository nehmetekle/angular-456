<div class="products-page">
  <div *ngIf="loading$ | async" class="loading">Loading products…</div>

  <div *ngIf="error$ | async as err" class="error">Error: {{ err | json }}</div>
  <div class="controls">
    <label
      >Per page:
      <select (change)="changePageSize($any($event.target).value)" [value]="pageSize">
        <option [value]="5">5</option>
        <option [value]="10">10</option>
        <option [value]="20">20</option>
      </select>
    </label>
  </div>

  <ul class="products-list">
    <li *ngFor="let p of products$ | async" class="product-item">
      <div class="product-card" [class.animate]="recentlyAddedId === p.id">
        <div class="product-image">
          <a [routerLink]="['/app/shop/products', p.id]"
            ><img [src]="p.image || '/assets/avif-test-image.avif'" alt="{{ p.name }}"
          /></a>
        </div>
        <div class="product-body">
          <div class="product-name">
            <a [routerLink]="['/app/shop/products', p.id]">{{ p.name }}</a>
          </div>
          <div class="product-desc">
            {{ p.description || 'High-quality item — ideal for everyday use.' }}
          </div>
        </div>
        <div class="product-side">
          <div class="product-price">{{ p.price | currency }}</div>
          <div class="stock" *ngIf="p.stock as s">
            <small *ngIf="s > 0" class="in">In stock</small>
            <small *ngIf="s <= 0" class="out">Out of stock</small>
          </div>
            <div class="product-actions">
            <button class="ghost" (click)="showRating(p.id)">Show rating</button>
            <button class="add-to-cart" (click)="addToCartWithFeedback(p)" [disabled]="(p.stock ?? 0) <= 0" [class.animate]="recentlyAddedId === p.id">Add to cart</button>
          </div>
          <div *ngIf="(selectedId$ | async) === p.id" class="rating">
            Rating: {{ selectedRating$ | async }}
          </div>
        </div>
      </div>
    </li>
  </ul>

  <div *ngIf="addedMessage" class="added-toast">{{ addedMessage }}</div>

  <ng-container *ngIf="count$ | async as total">
    <ng-container *ngIf="totalPages$ | async as totalPages">
      <div class="pagination">
        <button (click)="prevPage()" [disabled]="page === 1">‹ Prev</button>
        <span class="page-info"
          >Page <strong>{{ page }}</strong> / <strong>{{ totalPages }}</strong></span
        >
        <button (click)="nextPage(totalPages)" [disabled]="page >= totalPages">Next ›</button>
        <span class="total-count">({{ total }} items)</span>
      </div>
    </ng-container>
  </ng-container>
</div>
