<div class="checkout-shell">
  <h2>Checkout</h2>

  <div class="steps">
    <div class="step" [class.active]="step === 1">1. Cart Summary</div>
    <div class="step" [class.active]="step === 2">2. Address</div>
    <div class="step" [class.active]="step === 3">3. Confirmation</div>
  </div>

  <section *ngIf="step === 1" class="step-panel">
    <h3>Cart Summary</h3>
    <div *ngIf="items$ | async as items">
      <div *ngIf="items.length; else empty">
        <ul class="summary-list">
          <li *ngFor="let it of items">
            <div class="s-name">{{ it.product.name }}</div>
            <div class="s-qty">x{{ it.quantity }}</div>
            <div class="s-line">{{ it.product.price * it.quantity | number: '1.2-2' }} €</div>
            <div class="mini-stock" *ngIf="it.product?.stock as s">
              <small *ngIf="s > 0" class="in">In stock: {{ s }}</small>
              <small *ngIf="s <= 0" class="out">Out of stock</small>
            </div>
            <div *ngIf="isUnavailable(it.product.id)" class="unavailable-note">
              <small class="out">Unavailable</small>
            </div>
          </li>
        </ul>
        <div class="summary-numbers">
          <div>Subtotal: {{ subtotal$ | async | number: '1.2-2' }} €</div>

          <!-- Coupon moved to Payment step (step 2) to show payment breakdown first -->

          <ng-container *ngIf="(discount$ | async) as d">
            <div *ngIf="d > 0">Discount: -{{ d | number: '1.2-2' }} €</div>
          </ng-container>

          <ng-container *ngIf="(subtotal$ | async) as st">
            <ng-container *ngIf="(discount$ | async) as d">
              <div *ngIf="st - (d || 0) > 0">Tax: {{ (st * 0.2) | number: '1.2-2' }} €</div>
            </ng-container>
          </ng-container>

          <!-- Total shown below the summary, panel footer will present final total -->
        </div>
        <div class="panel-total">
          <ng-container *ngIf="step === 1">
            <div class="total-label">Total (excl. shipping):</div>
            <div class="total-value">
              {{ totalExShipping$ | async | number: '1.2-2' }} €
              <span *ngIf="isValidating" class="spinner">Updating…</span>
            </div>
          </ng-container>
        </div>
      </div>
      <ng-template #empty>
        <p>Your cart is empty.</p>
      </ng-template>
    </div>
    <div class="actions">
      <button class="btn btn-primary" (click)="next()" [disabled]="(items$ | async)?.length === 0">Next: Address</button>
    </div>
  </section>

  <section *ngIf="step === 2" class="step-panel">
    <h3>Shipping Address</h3>
    <form #addr="ngForm">
      <label>
        Full name
        <input name="name" required [(ngModel)]="address.name" />
      </label>
      <label>
        Address line 1
        <input name="line1" required [(ngModel)]="address.line1" />
      </label>
      <label>
        City
        <input name="city" required [(ngModel)]="address.city" />
      </label>
      <label>
        Postal code
        <input name="postal" required [(ngModel)]="address.postal" />
      </label>
      <label>
        Country
        <input name="country" required [(ngModel)]="address.country" />
      </label>
    </form>
    <div class="payment-breakdown">
      <h4>Payment details</h4>
      <div>Subtotal: {{ subtotal$ | async | number: '1.2-2' }} €</div>
      <ng-container *ngIf="(discount$ | async) as d">
        <div *ngIf="d > 0">Discount: -{{ d | number: '1.2-2' }} €</div>
      </ng-container>
      <div>Tax (20%): {{ ((subtotal$ | async) || 0) * 0.2 | number: '1.2-2' }} €</div>
      <div *ngIf="(shipping$ | async) as sh">Shipping: {{ sh | number: '1.2-2' }} €</div>
      <div class="summary-total">Total: {{ total$ | async | number: '1.2-2' }} €</div>
      <div class="payment-note"><small>Enter a coupon below to apply discounts to the payment.</small></div>
    </div>
    <div class="shipping-options">
      <h4>Delivery options</h4>
      <label *ngFor="let opt of shippingOptions">
        <input type="radio" name="shipping" [value]="opt.id" [(ngModel)]="selectedShipping" (change)="shippingChanged()" />
        {{ opt.name }} — {{ opt.price | number: '1.2-2' }} €
      </label>
      <div class="shipping-help">
        <small>Select your preferred delivery method. Prices may vary.</small>
      </div>
    </div>
    <div class="coupon">
      <input placeholder="Coupon code" [(ngModel)]="couponCode" />
      <button (click)="applyCoupon()" [disabled]="!couponCode">Apply</button>
      <button *ngIf="(coupon$ | async) as c" (click)="removeCoupon()" [disabled]="!c">Remove</button>
      <div class="coupon-info" *ngIf="(coupon$ | async) as c">
        <small *ngIf="c?.code">Applied: {{ c.code }} {{ c?.percent ? '(' + c.percent + '%)' : '' }}</small>
      </div>
      <div *ngIf="lastSummary?.coupon && lastSummary.coupon.percent === 0" class="coupon-invalid">
        <small class="out">Coupon invalid or not applicable</small>
      </div>
    </div>
    <div class="panel-total">
      <div class="total-label">Total:</div>
      <div class="total-value">{{ total$ | async | number: '1.2-2' }} € <span *ngIf="isValidating" class="spinner">Updating…</span></div>
    </div>
    <div class="actions">
      <button class="btn btn-ghost" (click)="back()">Back</button>
      <button class="btn btn-primary" (click)="confirmOrder()" [disabled]="processing || !address.name || !address.line1 || hasUnavailable">
        Confirm Order
      </button>
      <div *ngIf="hasUnavailable" class="unavailable-warning"><small class="out">Some items unavailable — adjust your cart</small></div>
    </div>
  </section>

  <section *ngIf="step === 3" class="step-panel">
    <h3>Confirmation</h3>
    <div *ngIf="orderResult; else processingTpl">
      <div class="confirmation-card">
        <div class="conf-section">
          <h4>Order</h4>
          <div>Order ID: <strong>{{ orderResult.id }}</strong></div>
          <div>Status: {{ orderResult.status }}</div>
          <div>Placed: {{ orderResult.created_at | date:'short' }}</div>
        </div>
        <div class="conf-section">
          <h4>Items</h4>
          <ul class="summary-list">
            <li *ngFor="let it of orderResult.items || (items$ | async)">
              <div>{{ it.name || it.product?.name }}</div>
              <div>x{{ it.quantity }}</div>
              <div>{{ (it.line_total ?? (it.product?.price * it.quantity)) | number:'1.2-2' }} €</div>
            </li>
          </ul>
        </div>
        <div class="conf-section">
          <h4>Shipping</h4>
          <div>Method: {{ orderResult.shipping_method || selectedShipping || 'standard' }}</div>
          <div>Estimated delivery: {{ orderResult.estimated_delivery | date }}</div>
        </div>
        <div class="conf-section">
          <h4>Payment</h4>
          <div>Subtotal: {{ orderResult.subtotal | number:'1.2-2' }} €</div>
          <div *ngIf="orderResult.discounts > 0">Discount: -{{ orderResult.discounts | number:'1.2-2' }} €</div>
          <div>Tax: {{ orderResult.tax | number:'1.2-2' }} €</div>
          <div>Shipping: {{ orderResult.shipping | number:'1.2-2' }} €</div>
        </div>
        <div class="conf-total">
          <div class="total-label">Total paid</div>
          <div class="total-value">{{ orderResult.total | number:'1.2-2' }} €</div>
        </div>
      </div>
    </div>
    <ng-template #processingTpl>
      <p *ngIf="processing">Processing order…</p>
      <p *ngIf="!processing && !orderResult">No order information available.</p>
    </ng-template>
    <div class="actions">
      <button class="btn btn-primary" (click)="goToShop()">Back to shop</button>
    </div>
  </section>
</div>
